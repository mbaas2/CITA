:class JenkinsConnection
    :field private crumb←''
    :field public CISERVER←'http://jenkins.dyalog.bramley'
    :field public JENKINS_USERNAME←''
    :field public JENKINS_APIKEY←''
    :field public JOBNAME←''
    :field public LOCKFILE←'' ''  ⍝ LOCKFILE  [1] from local perspective, [2] as seen from Jenkins  (to deal with U: vs. /devt/)
    :field public debug←1
    :field public Cleanup←1
    :field public Labels←''  ⍝ vtv with labels to use...
    :field public CITA_VERSION←'cita_latest'
    :field public Commandline←''

    :field public load_workspace←''

    :field private cookie
    :field private NL←⎕ucs 13


    :section Internals
    env←{0=≢r←⍎⍵: 2 ⎕NQ'.' 'GetEnvironment'⍵ ⋄ r}     ⍝ get value from environment-variable or .dcfg IF the field is not set

    :property CREDS
        ∇ R←get
          :Access public
          R←JENKINS_USERNAME,':',JENKINS_APIKEY
        ∇
    :endproperty

    ∇ New0
      :Implements constructor
      :Access   public
      CISERVER←env'CISERVER'
      JENKINS_USERNAME←env'JENKINS_USERNAME'
      JENKINS_APIKEY←env'JENKINS_APIKEY'
      Init
    ∇

    ∇ New1 ciserver
      :Access   public
      :Implements constructor
      CISERVER←ciserver
      JENKINS_USERNAME←env'JENKINS_USERNAME'
      JENKINS_APIKEY←env'JENKINS_APIKEY'
      Init
    ∇

    ∇ New2(ciserver usr)
      :Access   public
      :Implements constructor
      CISERVER←ciserver
      JENKINS_USERNAME←usr
      JENKINS_APIKEY←env'JENKINS_APIKEY'
      Init
    ∇

    ∇ Init
      ⎕SE.SALT.Load HomeDir,'HttpCommand -target=#'         ⍝ needs Brians updates from Feb3d, so we need to keep it in the same folder!
      crumb←(get'/crumbIssuer/api/json').crumb
    ∇


    ∇ R←HomeDir;src
      :If '18.0'≡4↑2⊃'.'⎕WG'aplversion'
          src←5179⌶1⊃⎕SI
      :Else
          src←50 ⎕ATX 1⊃⎕SI
      :EndIf
      R←1⊃⎕NPARTS src
    ∇


    ∇ R←{opt}get url;prms
    ⍝ opt= undefined | 1 (to return result and instance of HttpCommand that was created & execxuted)
      try←1
     TryAgain:
      :If 0=⎕NC'opt' ⋄ opt←0 ⋄ :EndIf
      :If CISERVER≢(≢CISERVER)↑url   ⍝ prefix server if not done yet
          url←CISERVER,url
      :EndIf
      prms←⎕NS''
      prms.u←CREDS
      res←#.HttpCommand.Get url prms
      ⍝ res←#.HttpCommand.Get url prms
⍝       res←h.Run
      :If res.rc=0
          :If opt=0
              :Trap 0
                  R←⎕JSON res.Data
              :Else
               ⍝ Could not JSONify res.Data!
               ⍝ happens for example with http://jenkinstest.dyalog.bramley/job/MB-Test1/1/consoleText/api/json  (despite /api/json suffix!)
               ⍝ no idea if I could do anything better...
                  R←res.Data
              :EndTrap
     
          :Else ⍝ opt=1
              R←res h
          :EndIf
          :If 0<≢c←{2⊃(⍵⍪⊂'')[⍵[;1]⍳⊂'Set-Cookie';]}res.Headers
              cookie←c
          :EndIf
      :Else
          :If res.rc=1106
              ⍞←'Call to "',url,'" ended with rc=1106'
              :If try<5
                  ⍞←' - trying again'
                  try+←1
                  →TryAgain
              :Else
                  ⍞←'Giving up'
                  ∘∘∘
              :EndIf
          :EndIf
          ⎕←'Call to "',url,'" did not end with rc=0'
          ⎕←res,'    ⍝ res'
          :If 0<≢res.Data
              ⎕←('<.*>(.*)</.*>'⎕S'\1'⍠'Greedy' 0)¨('id="error-description".*>(.*</div>)'⎕S'\1'⍠'Greedy' 0)res.Data
          :EndIf
          (1+⊃⎕LC)⎕STOP⊃⎕SI
          ⎕←(1+⊃⎕LC),' ⎕STOP ',⊃⎕SI
     
      :EndIf
    ∇


    ∇ R←{data}post url_addHd;url;addHd;Headers;res;retC;h
    ⍝ ⍺=undefined | data to post | 1 (to return the instance of HttpCommand that was generated & executed)
      retC←0
      :If 0=⎕NC'data' ⋄ data←'' ⋄ :EndIf
      :If data≡1 ⋄ retC←data ⋄ data←'' ⋄ :EndIf
      (url addHd)←2↑(⊆url_addHd),⊂''
      url←((1+url⍳'/')↑url),CREDS,'@',(1+url⍳'/')↓url  ⍝ use authentication with credentials in URL
      Headers←1 2⍴'Cookie'cookie
      Headers⍪←'Jenkins-Crumb'crumb
      Headers⍪←'u'CREDS
      :If 0<≢addHd ⋄ Headers⍪←addHd ⋄ :EndIf
      h←⎕NEW #.HttpCommand('post'url data Headers)
     
      res←h.Run
      :If res.rc=0
      :AndIf res.HttpStatus∊200 201
          R←res.(rc Data)
          ⎕←'─── Called ',url,' and got this'
          ⎕←(⎕JSON⍠'Compact' 0)res.Data
          :If retC=1
              R←res h
          :EndIf
     
      :Else
          (⊂res.Data)⎕NPUT(file,'.err.html')1  ⍝ TODO: this can probably be moved down inside the :Else - otherwise we don't really need that answer anymore...
          :If 0=≢err←('<.*>(.*)</.*>'⎕S'\1'⍠'Greedy' 0)¨('id"error-description".*>(.*</div>)'⎕S'\1'⍠'Greedy' 0)res.Data
              err←∊('name="skip2content".*>(.*)</div>'⎕S'\1'⍠'Greedy' 0)res.Data
          :EndIf
          :If 0<≢err
              R←1('Could not create job, got unexpected rc. Saved returned msg in ',file,'.err.html, relevant portion extracted as "',(∊err),'"')
          :Else
              ⎕←'Call to "',url,'" did not end with rc=0 (and HttpStatus=200)'
              ⎕←res,'    ⍝ res'
              (1+⊃⎕LC)⎕STOP⊃⎕SI
          :EndIf
      :EndIf
    ∇

    :endsection


    :section Public Methods


    ∇ ns←file RunJob jobname;h;con;⎕TRAP;r;bin;url;res;sink;cv;binPre;binPost;rdbl;ns;rc
      :Access public
      :If ''≢1⊃LOCKFILE
          :While ⎕NEXISTS 1⊃LOCKFILE
          :EndWhile
          (⊂⍕⎕TS)⎕NPUT 1⊃LOCKFILE
      :EndIf
      ns←⎕NS''
⍝ R=rc     success or not? (0=ok, 2nd)
⍝    msg  processing log if rc[1]=0, errMsg otherwise
⍝ ## Create the Jenkins job
⍝ echo "Creating Jenkins Job"
⍝ curl -s -XPOST "${CISERVER}/createItem?name=${JOBNAME}" --data-binary @jobTemplate.xml -H "$CRUMB" -H "Content-Type:text/xml" -u $CREDS
     
      rc←0 ⋄ log←''
      :If 0=≢jobname ⋄ jobname←env'JOBNAME' ⋄ :EndIf
      :If 0=≢jobname ⋄ 'No JOBNAME given!'⎕SIGNAL 11 ⋄ :EndIf
      JOBNAME←'CITA_',jobname
      url←CISERVER,'/createItem?name=',JOBNAME
      bin←1⊃⎕NGET file
    ⍝   :If 0<≢load_workspace
    ⍝       dws←∊1↓⎕NPARTS load_workspace
    ⍝       ('u:\apltools\CITA\',dws)(⎕NCOPY⍠'IfExists' 'Replace')load_workspace
    ⍝       bin←('$APP'⎕R'/devt/apltools/CITA'⍠('Regex' 0))bin
    ⍝   :EndIf
      i←⍸'<script>'⍷bin ⋄ binPre←(i+7)↑bin ⋄ bin←(i+7)↓bin
      i←⍸'</script>'⍷bin ⋄ binPost←(i-1)↓bin ⋄ bin←(i-1)↑bin
      ⍝ evaluate :if/:endif inside script template
      ⍝ pragmatic, quick solution. does not handle nested structures and has no :else-part.
      :While 0<⍴i←(':if'⍷bin)/⍳⍴bin
          pre←(i[1]-1)↑bin
          ⎕←if←{(¯1+⍵⍳⎕UCS 10)↑⍵}(i[1]+2)↓bin
          :Trap 0
              ⎕←if←(,1)≡,⍎if
          :Else
              if←0
          :EndTrap
          bin←{(⍵⍳⎕UCS 10)↓⍵}i[1]↓bin  ⍝ drop everything including :if-line
          :Repeat
              line←bin[⍳bin⍳⎕UCS 10] ⋄ bin←(≢line)↓bin ⍝ drop processed line
              :If if∧~z←∨/':endif'⍷line  ⍝ now process lines until we reach next endif
                  pre,←line
              :EndIf
          :Until z
          bin←pre,bin
      :EndWhile
      :If 0<≢Labels
          Labels←(⊂'&apos;'),¨Labels,¨⊂'&apos;'
          Labels←¯1↓∊Labels,','
          bin←('%LABELS%'⎕R Labels⍠'Regex' 0)bin
      :EndIf
     
     
⍝      (⊂bin)⎕NPUT(file,'.submitteded')1
      cv←''
      :If 0<≢CITA_VERSION
          cv←CITA_VERSION
          bin←('%CITA_VERSION%'⎕R cv⍠('Regex' 0))bin
      :EndIf
      bin←('%LOCKFILE%'⎕R (2⊃LOCKFILE)⍠('Regex' 0))bin
 ⍝     ⎕←'file=',file
⍝      (⎕lc[1]+1)⎕stop 1⊃⎕si
      bin←('&(?![a-z]*;)'⎕R'&amp;')bin
      bin←('"' '''' '%cmdline%' '<' '>'⎕R'&quot;' '&apos;'Commandline'&lt;' '&gt;'⍠('Regex' 0))bin
     
      bin←binPre,bin,binPost
      res←bin post(url(1 2⍴'Content-Type' 'application/xml'))
      (⊂bin)⎕NPUT(file,'.submitted')1     ⍝ save script as it was submitted
      rdbl←('&quot;' '&apos;' '&amp;' '&lt;' '&gt;'⎕R(,¨'"''&<>')⍠'Regex' 0)bin
     
      (⊂rdbl)⎕NPUT(file,'.subm.rdbl')1     ⍝ a human-readable form
     
      :If 0≠⊃res
          :If ∨/'A job already exists with the name'⍷2⊃res
          ⍝ see: http://jenkins.dyalog.bramley/view/CITA%20Builds/job/CITA_conga-apl_main/api/
          ⍝ http://jenkins.dyalog.bramley/view/CITA%20Builds/job/CITA_conga-apl_main/config.xml
              ⎕NDELETE file,'.err.html'   ⍝ no need to keep this error, as we know how to deal with it!
              url←CISERVER,'/job/',JOBNAME,'/config.xml'
              res←bin post(url(1 2⍴'Content-Type' 'application/xml'))
              :If 0≠⊃res
                  ∘∘∘
              :EndIf
          :ElseIf debug
              ⎕←'Unexpected result after positing to ',url
              res
              ∘∘∘
          :EndIf
     
      :EndIf
    ⍝ ## Run the jenkins job
    ⍝ echo "Running Job"
    ⍝ curl -s -XPOST "${CISERVER}/job/${JOBNAME}/build" -H "$CRUMB" -u $CREDS
      :If debug ⋄ ⎕←'Running job' ⋄ :EndIf
      (r h)←1 post CISERVER,'/job/',JOBNAME,'/build' ⍝ use authentication with credentials in URL
      :If r.rc=0
      :AndIf r.HttpStatus∊200 201
⍝ Jenkins takes a moment to start the job, the lastBuild will return a 404 until the FIRST job is running or has completed
          url←r.Headers{2⊃⍺[⍺[;1]⍳⊂⍵;]}'Location'
          ns.url←url
          h.URL←{((1+⍵⍳'/')↑⍵),CREDS,'@',(1+⍵⍳'/')↓⍵}url,'api/json'
     
          :If debug ⋄ ⎕←'Waiting for job to complete' ⋄ :EndIf
          :Repeat
              r←h.Run
          :Until 9=(⎕JSON r.Data).⎕NC'executable'
          :OrIf r.rc≠0
          :If r.rc≠0
              ns.rc←r.rc
              ns.Data←⎕JSON r.Data
              →0
          :EndIf
     
     
          h.URL←(⎕JSON r.Data).executable.url,'api/json?',#.HttpCommand.UrlEncode'depth=2&tree=builds[actions[parameters[name,value]],number,result]'
          :Repeat
              r←h.Run
          :Until (⎕JSON r.Data).building≢⊂'true'
          :OrIf r.rc≠0
          ns.Data←⎕JSON r.Data
     
        ⍝ # Show the console output
        ⍝ curl ${CISERVER}/job/${JOBNAME}/${JID}/consoleText
     
          ⎕←'Ready to retrieve the log!'
          ⎕←(⎕json ⍠'Compact'0)(⎕json r.Data)
          ∘∘∘
          ns.log←get(⎕JSON r.Data).url,'consoleText'
          ⍝ h.Command←'get'
          ⍝ con←h.Run
     
        ⍝ #Cleanup
          :If Cleanup
              :If debug=1 ⋄ ⎕←'Deleting job' ⋄ :EndIf
              (rc sink)←post CISERVER,'/job/',JOBNAME,'/doDelete'
              :If 0≠rc
                  (1+1⊃⎕LC)⎕STOP debug/1⊃⎕SI
                  ⎕←'Error deleting job'
              :EndIf
              ns.rc←rc
          :EndIf
      :Else
          ns.log←'Unexpected rc from "build":' ⋄ ⎕←r
          ns.rc←r.rc
      :EndIf
      :if ''≢1⊃LOCKFILE
      :andif ⎕nexists 1⊃LOCKFILE
     ⎕ndelete 1⊃LOCKFILE
     :endif
    ∇
    :endsection

    :Section Sample (with the Run-function)
    ∇ (rc log)←Run jobFile;file;⎕TRAP;j
      :Access public shared
      :If 0=≢jobFile
          :If ⎕NEXISTS file←'./jobTemplate.xml'
          :OrIf ⎕NEXISTS file←(1⊃⎕NPARTS 1⊃2 ⎕ATX 1⊃⎕SI),'jobTemplate.xml'
      ⍝ nothing to do
          :Else
              ⎕←'Could not find jobTemplate (jobFile empty, file=',file,')'
              ∘∘∘
          :EndIf
      :Else
          file←jobFile
      :EndIf
     
      j←⎕NEW JenkinsConnection
      j.(debug Cleanup load_workspace CITA_VERSION)←1 1 '' 'cita_latest'
      (rc log)←file j.RunJob'JOB1'
      (⊂log)⎕NPUT(file,'.log')1
    ∇
    :EndSection
:endclass
